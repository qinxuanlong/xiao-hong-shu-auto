# å°çº¢ä¹¦è‡ªåŠ¨åŒ–åˆ›ä½œåŠ©æ‰‹ - é¡¹ç›®ç»“æ„

## ç›®å½•æ ‘

```
auto/
â”œâ”€â”€ app/                          # ä¸»åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                   # FastAPI åº”ç”¨å…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                      # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ generate.py           # æ–‡æ¡ˆç”Ÿæˆæ¥å£
â”‚   â”‚   â”œâ”€â”€ cover.py              # å°é¢å›¾ç”Ÿæˆæ¥å£
â”‚   â”‚   â”œâ”€â”€ topics.py             # é€‰é¢˜ç®¡ç†æ¥å£
â”‚   â”‚   â””â”€â”€ export.py             # å¯¼å‡ºæ¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ core.py                   # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼ˆç»Ÿä¸€å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ load_config()         # è¯»å– config.json
â”‚   â”‚   â”œâ”€â”€ get_unpublished_topics()  # è·å–æœªå‘å¸ƒé€‰é¢˜
â”‚   â”‚   â””â”€â”€ generate_note_and_cover()  # ç”Ÿæˆæ–‡æ¡ˆå’Œå°é¢
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ content_service.py    # å†…å®¹ç”ŸæˆæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ cover_service.py      # å°é¢å›¾æœåŠ¡
â”‚   â”‚   â””â”€â”€ topic_service.py      # é€‰é¢˜ç®¡ç†æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ topic.py              # é€‰é¢˜æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ content.py            # ç”Ÿæˆå†…å®¹æ¨¡å‹
â”‚   â”‚   â””â”€â”€ config.py             # é…ç½®æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ templates/                # Jinja2 æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ base.html             # åŸºç¡€æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ index.html            # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ generate.html         # å†…å®¹ç”Ÿæˆé¡µ
â”‚   â”‚   â”œâ”€â”€ topics.html           # é€‰é¢˜ç®¡ç†é¡µ
â”‚   â”‚   â””â”€â”€ history.html          # å†å²è®°å½•é¡µ
â”‚   â”‚
â”‚   â”œâ”€â”€ static/                   # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â””â”€â”€ js/
â”‚   â”‚       â””â”€â”€ main.js
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ file_handler.py       # æ–‡ä»¶æ“ä½œ
â”‚       â”œâ”€â”€ csv_manager.py        # CSV ç®¡ç†
â”‚       â””â”€â”€ image_utils.py        # å›¾ç‰‡å¤„ç†å·¥å…·
â”‚
â”œâ”€â”€ data/                         # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ topics.csv                # é€‰é¢˜ç®¡ç† CSV
â”‚   â”‚   # å­—æ®µ: id,ç—›ç‚¹,äººç¾¤,ä¹¦ç±,é‡‘å¥,çŠ¶æ€,åˆ›å»ºæ—¶é—´
â”‚   â”œâ”€â”€ personal_snippets.txt     # çœŸäººè¯­å¥åº“ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰
â”‚   â””â”€â”€ templates/                # å†…å®¹æ¨¡æ¿
â”‚       â””â”€â”€ prompt_template.txt   # é€šä¹‰åƒé—®æç¤ºè¯æ¨¡æ¿
â”‚       #   å ä½ç¬¦: {ç—›ç‚¹}{äººç¾¤}{ä¹¦ç±}{é‡‘å¥}
â”‚
â”œâ”€â”€ output/                       # è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ drafts/                   # è‰ç¨¿æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ covers/                   # å°é¢å›¾æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ history.csv               # ç”Ÿæˆå†å²è®°å½•
â”‚
â”œâ”€â”€ assets/                       # ç´ æç›®å½•
â”‚   â”œâ”€â”€ fonts/                    # å­—ä½“æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ simhei.ttf            # é»‘ä½“å­—ä½“
â”‚   â”œâ”€â”€ backgrounds/              # èƒŒæ™¯å›¾
â”‚   â”‚   â”œâ”€â”€ bg_01.jpg
â”‚   â”‚   â””â”€â”€ bg_02.jpg
â”‚   â””â”€â”€ logos/                    # Logo/æ°´å°
â”‚       â””â”€â”€ watermark.png
â”‚
â”œâ”€â”€ config.json                   # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt              # ä¾èµ–æ¸…å•
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                   # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## æ–‡ä»¶ä½œç”¨è¯´æ˜

### ğŸ“ åº”ç”¨å±‚ (app/)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `main.app` | FastAPI åº”ç”¨å…¥å£ï¼Œæ³¨å†Œè·¯ç”±ã€ä¸­é—´ä»¶ã€é™æ€æ–‡ä»¶ |
| `api/*.py` | HTTP è·¯ç”±å±‚ï¼Œå¤„ç†å‰ç«¯è¯·æ±‚ï¼Œè°ƒç”¨ services å±‚ |
| `core.py` | æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šload_config()ã€get_unpublished_topics()ã€generate_note_and_cover() |
| `services/*.py` | ä¸šåŠ¡é€»è¾‘å±‚ï¼Œç»„ç»‡æ ¸å¿ƒåŠŸèƒ½å®Œæˆå…·ä½“ä»»åŠ¡ |
| `models/*.py` | Pydantic æ•°æ®æ¨¡å‹ï¼Œå®šä¹‰è¯·æ±‚/å“åº”ç»“æ„ |
| `templates/*.html` | Jinja2 HTML æ¨¡æ¿ï¼Œå‰ç«¯é¡µé¢ |
| `static/*` | CSS æ ·å¼å’Œ JavaScript äº¤äº’è„šæœ¬ |
| `utils/*.py` | é€šç”¨å·¥å…·å‡½æ•°ï¼šæ–‡ä»¶å¤„ç†ã€CSV æ“ä½œã€å›¾ç‰‡å·¥å…· |

### ğŸ“ æ•°æ®å±‚ (data/)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `topics.csv` | é€‰é¢˜æ•°æ®åº“ï¼Œå­—æ®µï¼šid,ç—›ç‚¹,äººç¾¤,ä¹¦ç±,é‡‘å¥,çŠ¶æ€,åˆ›å»ºæ—¶é—´ |
| `personal_snippets.txt` | çœŸäººè¯­å¥åº“ï¼ˆæ¯è¡Œä¸€æ¡ï¼Œç”¨äºæ›¿æ¢æ–‡æ¡ˆä¸­çš„å›ºå®šè¯­å¥ï¼‰ |
| `templates/prompt_template.txt` | é€šä¹‰åƒé—®æç¤ºè¯æ¨¡æ¿ï¼Œå ä½ç¬¦ï¼š{ç—›ç‚¹}{äººç¾¤}{ä¹¦ç±}{é‡‘å¥} |
| `templates/cover_template.jpg` | å°é¢å›¾èƒŒæ™¯æ¨¡æ¿ |

### ğŸ“ è¾“å‡ºå±‚ (output/)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `drafts/` | ç”Ÿæˆçš„æ–‡æ¡ˆè‰ç¨¿ï¼ˆMarkdown æ ¼å¼ï¼‰ |
| `covers/` | ç”Ÿæˆçš„å°é¢å›¾ï¼ˆPNG/JPG æ ¼å¼ï¼‰ |
| `history.csv` | æ‰€æœ‰ç”Ÿæˆä»»åŠ¡çš„è®°å½• |

### ğŸ“ ç´ æå±‚ (assets/)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `fonts/` | å°é¢å›¾ä½¿ç”¨çš„å­—ä½“æ–‡ä»¶ |
| `backgrounds/` | å°é¢å›¾èƒŒæ™¯ç´ æ |
| `logos/` | æ°´å°ã€Logo ç­‰ç´ æ |

### ğŸ“„ æ ¹ç›®å½•é…ç½®

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `config.json` | åº”ç”¨é…ç½®ï¼šç«¯å£ã€è·¯å¾„ã€AI å‚æ•°ç­‰ |
| `requirements.txt` | Python ä¾èµ–åŒ…åˆ—è¡¨ |
| `.env.example` | ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼ˆAPI Keyã€å¯†é’¥ç­‰ï¼‰ |
| `.gitignore` | Git å¿½ç•¥è§„åˆ™ï¼ˆ.envã€output/ ç­‰ï¼‰ |
| `README.md` | é¡¹ç›®è¯´æ˜æ–‡æ¡£ |

---

## config.json ç¤ºä¾‹

```json
{
  "app": {
    "title": "å°çº¢ä¹¦åˆ›ä½œåŠ©æ‰‹",
    "host": "127.0.0.1",
    "port": 8000,
    "debug": true
  },
  "qwen": {
    "api_key": "${QWEN_API_KEY}",
    "model": "qwen-turbo",
    "temperature": 0.7,
    "max_tokens": 2000
  },
  "paths": {
    "data_dir": "data",
    "output_dir": "output",
    "assets_dir": "assets",
    "topics_csv": "data/topics.csv",
    "history_csv": "output/history.csv"
  },
  "cover": {
    "width": 1080,
    "height": 1440,
    "default_font": "assets/fonts/simhei.ttf",
    "default_background": "assets/backgrounds/bg_01.jpg"
  },
  "limits": {
    "max_title_length": 20,
    "max_content_length": 1000,
    "max_tags": 10
  }
}
```

---

## æ ¸å¿ƒ app/core.py æ¨¡å—

### å‡½æ•°è¯´æ˜

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `load_config()` | è¯»å–å¹¶è¿”å› config.json é…ç½®å­—å…¸ |
| `get_unpublished_topics()` | ç”¨ pandas è¯»å– topics.csvï¼Œè¿”å›æœªå‘å¸ƒçš„é€‰é¢˜åˆ—è¡¨ |
| `generate_note_and_cover(topic_idx)` | ç”Ÿæˆç¬”è®°è‰ç¨¿å’Œå°é¢å›¾ï¼Œè¿”å› (note_path, cover_path, status) |

### generate_note_and_cover() å·¥ä½œæµç¨‹

1. è¯»å– `data/personal_snippets.txt`ï¼Œéšæœºé€‰æ‹©ä¸€æ¡çœŸäººè¯­å¥
2. è¯»å– `data/templates/prompt_template.txt`ï¼Œç”¨é€‰é¢˜å­—æ®µå¡«å……å ä½ç¬¦ `{ç—›ç‚¹}{äººç¾¤}{ä¹¦ç±}{é‡‘å¥}`
3. è°ƒç”¨é€šä¹‰åƒé—® APIï¼š`dashscope.Generation.call(model="qwen-max", prompt=..., api_key=...)`
4. å°†è¿”å›æ–‡æ¡ˆä¸­çš„"çœŸçš„æ•‘äº†æˆ‘ï¼"æ›¿æ¢ä¸º"{éšæœºè¯­å¥} çœŸçš„æ•‘äº†æˆ‘ï¼"
5. ä¿å­˜æ–‡æ¡ˆåˆ° `output/note.txt`
6. ç”¨ Pillow æ‰“å¼€ `data/templates/cover_template.jpg`ï¼Œåœ¨å±…ä¸­ä½ç½®å†™ä¸Šæ ‡é¢˜ï¼ˆå–æ–‡æ¡ˆç¬¬ä¸€è¡Œï¼Œå»æ‰ #ï¼‰
   - `font_path` ä» config è¯»å–
   - å­—å· 48
   - ç™½è‰²æ–‡å­— + é»‘è‰²æè¾¹ï¼ˆstroke_width=2, stroke_fill="black"ï¼‰
7. ä¿å­˜å°é¢åˆ° `output/cover.jpg`
8. ç”¨ pandas æ‰¾åˆ°åŸ CSV ä¸­åŒ¹é…"ç—›ç‚¹+ä¹¦ç±"çš„è¡Œï¼Œæ›´æ–° status ä¸º "published"
9. è¿”å› `(note_path, cover_path, "success")`

---

## ä¾èµ–æ¸…å• (requirements.txt)

```
fastapi==0.104.1
uvicorn[standard]==0.24.0
jinja2==3.1.2
python-multipart==0.0.6
dashscope==1.14.0      # é€šä¹‰åƒé—® SDK
Pillow==10.1.0
pandas==2.1.3
pydantic==2.5.0
pydantic-settings==2.1.0
python-dotenv==1.0.0
requests==2.31.0
aiofiles==23.2.1
```

---

## å¿«é€Ÿå¯åŠ¨

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env å¡«å…¥ API Key
# QWEN_API_KEY=your_key_here

# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload
```

è®¿é—®ï¼šhttp://127.0.0.1:8000
